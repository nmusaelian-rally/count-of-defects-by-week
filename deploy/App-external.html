<!DOCTYPE html>
<html>
<head>
    <title>Defect count</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",numberOfWeeks:8,weeks:[],createdDefects:[],eightWeeksData:[],eightWeeksTTRData:[],arrayOfCreationDateFilters:[],arrayOfFixedFilters:[],arrayOfAdminClosedFilters:[],defectStore:null,launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait.This may take long..."}),this._myMask.show(),this.getDates(),this.createFilters(),this.makeStore()},getDates:function(){var now=new Date,today=now.getDay(),saturday=6,howFarBack=this.numberOfWeeks+1,saturdayDates=[],weeks=[],closestSaturday=null,prevSaturday=null,daysFromLastSaturday=today-saturday;closestSaturday=new Date(now-864e5*daysFromLastSaturday),saturdayDates.push(Rally.util.DateTime.format(closestSaturday,"Y-m-d")),console.log("today:",today,"daysFromLastSaturday:",daysFromLastSaturday,"closestSaturday:",closestSaturday);for(var i=1;howFarBack>i;i++){var prevSaturday=new Date(closestSaturday-6048e5);saturdayDates.push(Rally.util.DateTime.format(prevSaturday,"Y-m-d")),closestSaturday=prevSaturday}console.log("saturdayDates:",saturdayDates);for(var i=0;saturdayDates.length-1>i;i++){var week={};week.end=saturdayDates[i],week.start=saturdayDates[i+1],this.weeks.push(week)}},createFilters:function(){console.log(this.weeks);var tagFilter,codeResolitionFilter,adminResolutionFilter,closedFilter,fixedFilter,adminClosedFilter,closedDateFilters=[],creationDateFilters=[];tagFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Tags.Name",operator:"contains",value:"Customer Voice"}),closedFilter=tagFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"State",value:"Closed"})),codeResolitionFilter=Rally.data.wsapi.Filter.or([{property:"Resolution",value:"Code Change"},{property:"Resolution",value:"Database/Metadata Change"},{property:"Resolution",value:"Configuration Change"}]),adminResolutionFilter=Rally.data.wsapi.Filter.and([{property:"Resolution",operator:"!=",value:"Code Change"},{property:"Resolution",operator:"!=",value:"Database/Metadata Change"},{property:"Resolution",operator:"!=",value:"Configuration Change"}]),fixedFilter=closedFilter.and(codeResolitionFilter),adminClosedFilter=closedFilter.and(adminResolutionFilter),_.each(this.weeks,function(week){var creationDateFilter=Rally.data.wsapi.Filter.and([{property:"CreationDate",operator:">=",value:week.start},{property:"CreationDate",operator:"<",value:week.end}]),closedDateFilter=Rally.data.wsapi.Filter.and([{property:"ClosedDate",operator:">=",value:week.start},{property:"ClosedDate",operator:"<",value:week.end}]);this.arrayOfCreationDateFilters.push(tagFilter.and(creationDateFilter)),this.arrayOfFixedFilters.push(fixedFilter.and(closedDateFilter)),this.arrayOfAdminClosedFilters.push(adminClosedFilter.and(closedDateFilter))},this),console.log("-----CreationDate Filters-----"),_.each(this.arrayOfCreationDateFilters,function(filter){console.log(""+filter)},this),console.log("-----Fixed Filters-----"),_.each(this.arrayOfFixedFilters,function(filter){console.log(""+filter)},this),console.log("-----Admin Closed Filters-----"),_.each(this.arrayOfAdminClosedFilters,function(filter){console.log(""+filter)},this)},makeStore:function(){this.concatArrayOfFilters=this.arrayOfCreationDateFilters.concat(this.arrayOfFixedFilters,this.arrayOfAdminClosedFilters),this.defectStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",fetch:["Name","State","FormattedID","CreationDate","ClosedDate"],limit:1/0}),this.applyFiltersToStore(0)},applyFiltersToStore:function(i){this.defectStore.addFilter(this.concatArrayOfFilters[i]),this.defectStore.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&(this.eightWeeksData.push(records.length),i>=this.numberOfWeeks&&this.eightWeeksTTRData.push(this.getClosedDefectsWithinTTR(records)),this.defectStore.clearFilter(records.length),this.concatArrayOfFilters.length-1>i?this.applyFiltersToStore(i+1):(this.eightWeeksData=this.eightWeeksData.concat(this.eightWeeksTTRData),this.makeCustomStore()))}})},getClosedDefectsWithinTTR:function(records){var ttr=20,closedDefectWithinTTRCount=[],arrayOfDataObjects=[];return _.each(records,function(record){var created=new Date(record.get("CreationDate")),closed=new Date(record.get("ClosedDate")),diff=Math.floor((closed-created)/864e5);ttr>=diff&&closedDefectWithinTTRCount.push(record)},this),closedDefectWithinTTRCount.length},makeCustomStore:function(){var arrayOfObjects=[],chunksOfData=[],i,j,k,chunk=this.numberOfWeeks;for(i=0,j=this.eightWeeksData.length,k=0;j>i;i+=chunk,k++)chunksOfData[k]=this.eightWeeksData.slice(i,i+chunk);var zippedChunks=_.zip(chunksOfData);console.log("zippedChunks",zippedChunks);for(var i=0;zippedChunks.length>i;i++){for(var o={},j=0;zippedChunks[i].length>j;j++)o[j]=zippedChunks[i][j];arrayOfObjects.push(o)}console.log("arrayOfObjects",arrayOfObjects),this.makeGrid(arrayOfObjects)},makeGrid:function(data){this._myMask.hide();var mergedData=_.merge(data,this.weeks);console.log("mergedData",mergedData),this._grid=Ext.create("Rally.ui.grid.Grid",{itemId:"defectGrid",store:Ext.create("Rally.data.custom.Store",{data:data}),columnCfgs:[{text:"Start Week",dataIndex:"start"},{text:"End Week",dataIndex:"end"},{text:"Created Defects",dataIndex:"0"},{text:"Fixed Defect",dataIndex:"1"},{text:"Administratively Closed Defects",dataIndex:"2"},{text:"Fixed Defect (TTR <= 20)",dataIndex:"3"},{text:"Administratively Closed Defects (TTR <= 20)",dataIndex:"4"}],showPagingToolbar:!1}),this.add(this._grid)}});

            Rally.launchApp('CustomApp', {
                name:"Defect count",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
